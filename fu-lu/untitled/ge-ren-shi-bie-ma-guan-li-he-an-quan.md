# 个人识别码管理和安全

### ANSI X9.8 个人识别数字管理和安全

规定了 PINBLOCK格式 同ISO 9564 格式 0

### ISO 9564 金融服务——个人识别码（PIN）管理和安全

> [Bank services -- Personal Identification Number \(PIN\) management and security ](https://en.wikipedia.org/wiki/ISO_9564)
>
> [Financial services -- Personal Identification Number \(PIN\) management and security ](https://en.wikipedia.org/wiki/ISO_9564)

共计4部分，第一部分主要描述了PIN格式

对称算法 DES/3DES 块大小为64Bits 下的PINBLOCK格式

#### ISO格式 0 \(ISO-9564 PIN Format 0\)

输入

* 4-12位 PIN 数字                             _例如6位密码_ `123456`
* 12位不含校验位的账号 数字        _例如 16位卡号 6222123456789012获取的_ `212345678901`

处理

1. 计算PIN长度，转换为 Hex， 4-9，10，11，12 对应 4-9，A，B，C
2. 预创建一个 16Hex字符的空间
3. 第一字符填 0
4. 第二字符填入步骤1 对应的字符
5. 接下来填入对应长度的PIN
6. 填充 F 直到空间填满
7. 将12为账号左边填充 字符 0，满足16位
8. 将6和7的两块数据按位异或
9. 得到明文的PINBLOCK

输出

​ 明文PINBLOCK 例如 `06121575BA9876FE`

然后使用密钥对该密码块加密即可

#### ISO格式 1 \(ISO-9564 PIN Format 1\)

> 用于无账号格式

输入

* 4-12位 PIN 数字   _例如 6位密码_ `123456`

处理

1. 计算PIN长度，转换为 Hex， 4-9，10，11，12 对应 4-9，A，B，C
2. 预创建一个 16Hex字符的空间
3. 第一字符填  1
4. 第二字符填入步骤1 对应的字符
5. 接下来填入对应长度的PIN
6. 填充F 直到空间填满

输出

​ 明文PINBLOCK _例如_ `16123456FFFFFFFF`

然后使用密钥对该密码块加密即可

#### ISO格式 2 \(ISO-9564 PIN Format 2\)

> 用于脱机系统（例如IC读卡器与卡交互）

输入

* 4-12位 PIN 数字

处理

1. 计算PIN长度，转换为 Hex， 4-9，10，11，12 对应 4-9，A，B，C
2. 预创建一个 16Hex字符的空间
3. 第一字符填 2
4. 第二字符填入步骤1 对应的字符
5. 接下来填入对应长度的PIN
6. 填充F 直到空间填满

输出

​ 明文PINBLOCK `26123456FFFFFFFF`

然后使用密钥对该密码块加密即可

#### ISO格式 3 \(ISO-9564 PIN Format 3\)

输入

* 4-12位 PIN 数字
* 12位不含校验位的账号 数字

处理

1. 计算PIN长度，转换为 Hex， 4-9，10，11，12 对应 4-9，A，B，C
2. 预创建一个 16Hex字符的空间
3. 第一字符填 3
4. 第二字符填入步骤1 对应的字符
5. 接下来填入对应长度的PIN
6. 填充随机的 ABCDEF （不同于1的地方）直到空间填满
7. 将12为账号左边填充 字符 0，满足16位
8. 将6和7的两块数据按位异或
9. 得到明文的PINBLOCK

输出

​ 明文PINBLOCK

然后使用密钥对该密码块加密即可

#### ISO格式 4 \(ISO-9564 PIN Format 4\)

扩展的PIN格式 为AES 这类 块大小为128Bits设定的 参考[这里 9.4章节](http://www.doc88.com/p-1106363241940.html)

> 对比之前的格式，这个格式就显得极为复杂，而且最后加密异或就需要两次。这么设计也是出于一些考虑，例如POS机刷卡环境，当持卡人刷卡后输入密码并进行验证时，效果如下：
>
> 1. 在获取IC卡信息后，得到IC卡的账号信息PAN，组成PAN块
> 2. 用户在POS密码键盘输入密码后密码当即被密钥加密，输出纯PIN的密文块
> 3. 将1和2 结果异或 再次使用密钥加密即可得到结果
>
> 不过个人觉得这么设计在一些窃密/伪造攻击上安全性并不大。

输入

* 4-12位 PIN 数字
* PAN 全账号 12-19位 数字
* 密钥 K

处理

1. 计算PIN长度，转换为 Hex， 4-9，10，11，12 对应 4-9，A，B，C
2. 预创建一个 32 Hex字符的空间
3. 第一字符填 4
4. 第二字符填入步骤1 对应的字符
5. 接下来填入对应长度的PIN
6. 填充 A 直到空间填充为16 Hex
7. 在剩余的空间继续填充 随机的0-F 
8. 准备32Hex空间
9. 计算PAN长度 -12 也就是 取值0-7并写入空间
10. 填充PAN （12-19）
11. 如果PAN长度不是19，则继续填充 9步骤中的长度个 0
12. 继续填充 0 到满
13. 输出 7 得到的PIN块，12得到的PAN块
14. 使用密钥加密7得到的PIN块，得到密文块A
15. 使用密文块A 与12得到的PAN块异或，得到密文块B
16. 使用密钥再次加密密文块B得到最终的密文PINBLOCK

输出密文PINBLOCK

### 中国银联密码交换格式

#### QCUP 国密格式

输入

* 4-12位 PIN 数字                             _例如6位密码_ `123456`
* 12位不含校验位的账号 数字        _例如 16位卡号 6222123456789012获取的_ `212345678901`

处理

1. 计算PIN长度，转换为 Hex， 4-9，10，11，12 对应 4-9，A，B，C
2. 预创建一个 32Hex字符的空间
3. 第一字符填 0
4. 第二字符填入步骤1 对应的字符
5. 接下来填入对应长度的PIN
6. 填充 F 直到空间填满
7. 将12为账号左边填充 字符 0，满足16位
8. 将6和7的两块数据按位异或
9. 得到明文的PINBLOCK

输出

​ 明文PINBLOCK 例如 `06121575BA9876FE`

然后使用密钥对该密码块加密即可

#### QCUP 互联网密码格式

密码块是192bits 即 24字节数据，由密码长度（6-20）、密码明文-ASCII字符、以及填充组成。 并使用使用PIK 128Bits密钥加密

例如：

1. 用户互联网密码是字符密码 `Hello!123`，那么明文块格式 `09Hello!123`以及不可见的 13字节`0xff`填充组成。
2. 该格式可以包含PIN格式 6位数字。如用户密码采用的是PIN，例如`123456` 则明文块格式将是 `06123456`以及不可见的16字节 `0xff`填充组成。

规范中并未规定如何进行加密，一般的认为

* 国际算法 3DES

  进行DESede 对24字节块进行ECB方式加密（DES 数据每组 8字节，分三组），输出 24字节密文

* 国密算法 SM4

  规范中未提及，如何对数据填充（SM4 数据每组 16字节，第二块缺少 8字节），如果强制使用，可能存在两种加密方式

  1. 按照加密常用的填充方式，即对不足数据进行填 0 处理，即空白处填充 `0x00` ，输出 32字节密文
  2. 按照密码块格式，将密码块扩充为32字节，则继续对缺少的字节填充`0xff`，输出 32字节密文

  解密方式：

  为了不影响兼容性，且后续8字节不影响，则不对后8字节做数据检查直接丢弃，仅对 24字节块进行判断并检查格式

### 

